version: '3.8'

# Integrated E2E Test Environment
# Entity A + Entity B + E2E Test Runner
# 
# Usage:
#   docker-compose -f docker-compose.integrated.yml up --build
#   docker-compose -f docker-compose.integrated.yml up entity-a entity-b -d
#   docker-compose -f docker-compose.integrated.yml run e2e-test-runner

services:
  # ============================================
  # Entity A - Token Issuer & API Server
  # ============================================
  entity-a:
    build: .
    container_name: entity-a
    ports:
      - "8001:8001"
    environment:
      - ENTITY_ID=entity-a
      - ENTITY_PRIVATE_KEY=${ENTITY_A_PRIVATE_KEY:-aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa}
      - API_PORT=8001
      - PYTHONPATH=/app
      - DEBUG=true
      - LOG_LEVEL=INFO
    volumes:
      - ./services:/app/services
      - ./data/entity-a:/app/data
      - ./protocol:/app/protocol
    command: >
      python -c "
      import asyncio
      import sys
      import os
      sys.path.insert(0, '/app/services')
      
      from api_server import app
      import uvicorn
      
      async def main():
          print('='*60)
          print('Entity A - Token System API Server')
          print('='*60)
          print(f'Entity ID: entity-a')
          print(f'Port: 8001')
          print('Endpoints:')
          print('  POST /token/wallet/create')
          print('  GET  /token/wallet/{entity_id}')
          print('  POST /token/transfer')
          print('  GET  /token/wallet/{entity_id}/history')
          print('  POST /admin/mint')
          print('='*60)
          
          config = uvicorn.Config(app, host='0.0.0.0', port=8001, log_level='info')
          server = uvicorn.Server(config)
          await server.serve()
      
      asyncio.run(main())
      "
    networks:
      - ai-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # Entity B - Token Receiver & API Client
  # ============================================
  entity-b:
    build: .
    container_name: entity-b
    ports:
      - "8002:8002"
    environment:
      - ENTITY_ID=entity-b
      - ENTITY_PRIVATE_KEY=${ENTITY_B_PRIVATE_KEY:-bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb}
      - ENTITY_A_URL=http://entity-a:8001
      - API_PORT=8002
      - PYTHONPATH=/app
      - DEBUG=true
      - LOG_LEVEL=INFO
    volumes:
      - ./services:/app/services
      - ./data/entity-b:/app/data
      - ./protocol:/app/protocol
    command: >
      python -c "
      import asyncio
      import sys
      import os
      sys.path.insert(0, '/app/services')
      
      from api_server import app
      import uvicorn
      
      async def main():
          print('='*60)
          print('Entity B - Token System API Server')
          print('='*60)
          print(f'Entity ID: entity-b')
          print(f'Port: 8002')
          print(f'Connected to Entity A: http://entity-a:8001')
          print('='*60)
          
          config = uvicorn.Config(app, host='0.0.0.0', port=8002, log_level='info')
          server = uvicorn.Server(config)
          await server.serve()
      
      asyncio.run(main())
      "
    networks:
      - ai-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      entity-a:
        condition: service_healthy

  # ============================================
  # E2E Test Runner
  # ============================================
  e2e-test-runner:
    build: .
    container_name: e2e-test-runner
    environment:
      - ENTITY_A_URL=http://entity-a:8001
      - ENTITY_B_URL=http://entity-b:8002
      - PYTHONPATH=/app
    volumes:
      - ./tests/e2e:/app/tests/e2e
      - ./services:/app/services
    command: >
      python -m pytest tests/e2e/test_token_transfer_e2e.py -v
      --tb=short
      --color=yes
      -o log_cli=true
      -o log_cli_level=INFO
    networks:
      - ai-network
    depends_on:
      entity-a:
        condition: service_healthy
      entity-b:
        condition: service_healthy

  # ============================================
  # Token Transfer Demo
  # ============================================
  token-transfer-demo:
    build: .
    container_name: token-transfer-demo
    environment:
      - ENTITY_A_URL=http://entity-a:8001
      - ENTITY_B_URL=http://entity-b:8002
      - PYTHONPATH=/app
    volumes:
      - ./services:/app/services
    command: >
      python -c "
      import asyncio
      import aiohttp
      import sys
      sys.path.insert(0, '/app/services')
      
      ENTITY_A_URL = 'http://entity-a:8001'
      ENTITY_B_URL = 'http://entity-b:8002'
      
      async def demo():
          print('='*60)
          print('Token Transfer Demo: Entity A -> Entity B')
          print('='*60)
          
          async with aiohttp.ClientSession() as session:
              # 1. Health check
              print('\n1. Health Check...')
              async with session.get(f'{ENTITY_A_URL}/health') as resp:
                  print(f'   Entity A: {resp.status}')
              async with session.get(f'{ENTITY_B_URL}/health') as resp:
                  print(f'   Entity B: {resp.status}')
              
              # 2. Create wallets
              print('\n2. Creating wallets...')
              for url, name in [(ENTITY_A_URL, 'A'), (ENTITY_B_URL, 'B')]:
                  async with session.post(f'{url}/token/wallet/create') as resp:
                      print(f'   Entity {name}: {resp.status}')
              
              # 3. Mint tokens to A
              print('\n3. Minting 1000 tokens to Entity A...')
              async with session.post(
                  f'{ENTITY_A_URL}/admin/mint',
                  json={'recipient_id': 'entity-a', 'amount': 1000, 'reason': 'Demo'}
              ) as resp:
                  print(f'   Result: {resp.status}')
              
              # 4. Check balances
              print('\n4. Initial balances...')
              async with session.get(f'{ENTITY_A_URL}/token/wallet/entity-a') as resp:
                  data = await resp.json()
                  print(f'   Entity A: {data}')
              async with session.get(f'{ENTITY_B_URL}/token/wallet/entity-b') as resp:
                  data = await resp.json()
                  print(f'   Entity B: {data}')
              
              # 5. Transfer
              print('\n5. Transferring 100 tokens A -> B...')
              async with session.post(
                  f'{ENTITY_A_URL}/token/transfer',
                  json={'recipient_id': 'entity-b', 'amount': 100, 'reason': 'Demo transfer'}
              ) as resp:
                  print(f'   Result: {resp.status}')
                  if resp.status == 200:
                      data = await resp.json()
                      print(f'   Tx: {data}')
              
              # 6. Check final balances
              print('\n6. Final balances...')
              async with session.get(f'{ENTITY_A_URL}/token/wallet/entity-a') as resp:
                  data = await resp.json()
                  print(f'   Entity A: {data}')
              async with session.get(f'{ENTITY_B_URL}/token/wallet/entity-b') as resp:
                  data = await resp.json()
                  print(f'   Entity B: {data}')
              
              # 7. Check history
              print('\n7. Transaction history...')
              async with session.get(f'{ENTITY_A_URL}/token/wallet/entity-a/history') as resp:
                  if resp.status == 200:
                      data = await resp.json()
                      print(f'   Entity A history: {len(data) if isinstance(data, list) else data} items')
          
          print('\n' + '='*60)
          print('Demo completed!')
          print('='*60)
      
      asyncio.run(demo())
      "
    networks:
      - ai-network
    depends_on:
      - entity-a
      - entity-b

networks:
  ai-network:
    driver: bridge
