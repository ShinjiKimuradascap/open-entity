name: Deploy Messaging API

on:
  push:
    branches: [ main, master ]
    paths:
      - 'simple_message_api.py'
      - 'Dockerfile.simple'
      - '.github/workflows/deploy-messaging-api.yml'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Deployment platform'
        required: true
        default: 'render'
        type: choice
        options:
          - render
          - gcp
          - railway

jobs:
  # Render.com へのデプロイ（推奨 - 最も簡単）
  deploy-render:
    if: github.event.inputs.platform == 'render' || (github.event_name == 'push' && github.event.inputs.platform == null)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Render
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_MESSAGING_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
      
      - name: Wait and Verify
        run: |
          echo "Waiting for deployment..."
          sleep 45
          URL="https://${{ secrets.RENDER_MESSAGING_SERVICE_NAME }}.onrender.com"
          echo "Checking health at: $URL"
          curl -s "$URL/health" | jq . || curl -s "$URL/health"

  # GCP Cloud Run へのデプロイ
  deploy-gcp:
    if: github.event.inputs.platform == 'gcp'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v4
      
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker
        run: gcloud auth configure-docker
      
      - name: Build and Push
        run: |
          IMAGE="gcr.io/${{ secrets.GCP_PROJECT }}/messaging-api:${{ github.sha }}"
          docker build -f Dockerfile.simple -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
      
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: messaging-api
          region: asia-northeast1
          image: ${{ env.IMAGE }}
          env_vars: |
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            ENVIRONMENT=production
          flags: |
            --memory=512Mi
            --cpu=1
            --min-instances=0
            --max-instances=10
            --allow-unauthenticated
      
      - name: Verify Deployment
        run: |
          URL=$(gcloud run services describe messaging-api --region=asia-northeast1 --format='value(status.url)')
          echo "Service URL: $URL"
          sleep 10
          curl -s "$URL/health" | jq . || curl -s "$URL/health"

  # Railway へのデプロイ
  deploy-railway:
    if: github.event.inputs.platform == 'railway'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_MESSAGING_TOKEN }}
        run: |
          railway login --token "$RAILWAY_TOKEN"
          railway up --service=messaging-api --detach
      
      - name: Get URL
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_MESSAGING_TOKEN }}
        run: |
          railway status
