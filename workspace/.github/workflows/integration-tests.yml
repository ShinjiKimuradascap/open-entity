name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM

jobs:
  phase1-basic:
    runs-on: ubuntu-latest
    name: Phase 1 - Basic Functionality
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-xdist

      - name: Run Phase 1 tests with retry
        run: |
          python scripts/test_with_retry.py --category unit --verbose
          
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: '❌ Phase 1 tests failed (Python ${{ matrix.python-version }})'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
  phase2-crypto:
    runs-on: ubuntu-latest
    name: Phase 2 - Encryption Integration
    needs: phase1-basic
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          
      - name: Run Phase 2 tests with retry
        run: |
          python scripts/test_with_retry.py --category e2e --verbose
          
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: '❌ Phase 2 tests failed (Python ${{ matrix.python-version }})'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  phase2-l2-bootstrap:
    runs-on: ubuntu-latest
    name: Phase 2L - L2 Bootstrap Discovery (Entity B)
    needs: phase1-basic
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          
      - name: Run L2 Bootstrap tests with retry
        run: |
          python scripts/test_with_retry.py --category dht --verbose
          
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: '❌ Phase 2L tests failed (Python ${{ matrix.python-version }})'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
  phase3-peer:
    runs-on: ubuntu-latest
    name: Phase 3 - Peer Service Integration
    needs: phase2-crypto
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          
      - name: Run Phase 3 tests with retry
        run: |
          python scripts/test_with_retry.py --category integration --verbose
          
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: '❌ Phase 3 tests failed (Python ${{ matrix.python-version }})'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
  phase4-e2e:
    runs-on: ubuntu-latest
    name: Phase 4 - End-to-End Tests
    needs: phase3-peer
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
        
      - name: Run E2E tests with retry
        run: |
          python scripts/test_with_retry.py --category e2e --verbose
          
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: '❌ Phase 4 E2E tests failed (Python ${{ matrix.python-version }})'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  phase5-l1-l2-integration:
    runs-on: ubuntu-latest
    name: Phase 5 - L1+L2 Integration Tests
    needs: [phase3-peer, phase2-l2-bootstrap]
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
          
      - name: Run L1+L2 Integration tests with retry
        run: |
          python scripts/test_with_retry.py --category integration --verbose
          
      - name: Generate integration coverage
        run: |
          python -m pytest tests/integration/ --cov=services --cov-report=xml \
            --cov-report=html -v
          
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: '❌ Phase 5 L1+L2 Integration tests failed (Python ${{ matrix.python-version }})'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
  coverage:
    runs-on: ubuntu-latest
    name: Coverage Report
    needs: [phase1-basic, phase2-crypto, phase2-l2-bootstrap, phase3-peer, phase5-l1-l2-integration]
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov coverage
          
      - name: Generate coverage report
        run: |
          cd services
          python -m pytest --cov=. --cov-report=xml --cov-report=html -v
          
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./services/coverage.xml
          fail_ci_if_error: false
          
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: '❌ Coverage report generation failed (Python ${{ matrix.python-version }})'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
