name: Service Registration Regression Tests

on:
  schedule:
    # 毎日8時・20時JST（毎日23時・11時UTC）に実行
    - cron: '0 23 * * *'
    - cron: '0 11 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - stress
          - full
  push:
    paths:
      - 'services/marketplace/service_registry.py'
      - 'tests/regression/**'
      - '.github/workflows/regression-tests.yml'

jobs:
  # 標準回帰テスト
  regression-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run service registration regression tests
        run: |
          python -m unittest tests.regression.test_service_registration_regression -v

      - name: Upload regression report
        uses: actions/upload-artifact@v4
        with:
          name: regression-report
          path: reports/service_registration_regression_*.json

  # 負荷・ストレステスト
  stress-test:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'stress' || github.event.inputs.test_type == 'full'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run stress tests
        run: |
          python tests/regression/test_stress_registration.py

      - name: Upload stress test report
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-report
          path: reports/stress_test_*.json

  # テスト結果サマリー
  test-summary:
    runs-on: ubuntu-latest
    needs: [regression-test]
    if: always()
    steps:
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          name: regression-report
          path: reports/

      - name: Generate summary
        run: |
          echo "## Service Registration Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # 最新のレポートを読み込んでサマリー生成
          LATEST_REPORT=$(ls -t reports/service_registration_regression_*.json | head -1)
          if [ -f "$LATEST_REPORT" ]; then
            PASSED=$(python3 -c "import json; print(json.load(open('$LATEST_REPORT'))['summary']['passed'])")
            TOTAL=$(python3 -c "import json; print(json.load(open('$LATEST_REPORT'))['summary']['total'])")
            RATE=$(python3 -c "import json; print(json.load(open('$LATEST_REPORT'))['summary']['success_rate'])")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| Success Rate | $RATE% |" >> $GITHUB_STEP_SUMMARY
            echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "⚠️ Regression tests failed" >> $GITHUB_STEP_SUMMARY
