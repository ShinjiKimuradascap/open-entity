version: '3.8'

# E2Eテスト用Docker Compose
# 使用方法: docker-compose -f docker-compose.test.yml -f docker-compose.e2e.yml up --abort-on-container-exit

services:
  # E2Eテストランナー
  e2e-test-runner:
    build: .
    container_name: e2e-test-runner
    volumes:
      - ./tests/e2e:/app/tests/e2e
      - ./services:/app/services
    environment:
      - ENTITY_A_URL=http://entity-a:8001
      - ENTITY_B_URL=http://entity-b:8002
      - PYTHONPATH=/app
    command: >
      python -m pytest tests/e2e/ -v
      --tb=short
      --color=yes
      -o log_cli=true
      -o log_cli_level=INFO
    networks:
      - peer-network
    depends_on:
      entity-a:
        condition: service_healthy
      entity-b:
        condition: service_healthy

  # ヘルスチェック用ユーティリティ
  wait-for-services:
    image: busybox
    container_name: wait-for-services
    command: >
      sh -c '
        echo "Waiting for Entity A..."
        while ! wget -qO- http://entity-a:8001/health > /dev/null 2>&1; do
          sleep 1
        done
        echo "Entity A is ready"
        
        echo "Waiting for Entity B..."
        while ! wget -qO- http://entity-b:8002/health > /dev/null 2>&1; do
          sleep 1
        done
        echo "Entity B is ready"
        
        echo "All services are ready for E2E tests"
      '
    networks:
      - peer-network
    depends_on:
      - entity-a
      - entity-b

networks:
  peer-network:
    driver: bridge
