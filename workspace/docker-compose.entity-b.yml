version: '3.8'

# Entity B 専用 Docker Compose
# Entity Aと連携するための設定

services:
  # Entity B - ピアクライアント兼APIサーバー
  entity-b:
    build: .
    container_name: entity-b
    ports:
      - "8002:8002"
    environment:
      - ENTITY_ID=entity-b
      - ENTITY_PRIVATE_KEY=${ENTITY_B_PRIVATE_KEY:-bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb}
      - ENTITY_A_URL=http://entity-a:8001
      - API_PORT=8002
      - PYTHONPATH=/app
      - DEBUG=true
      - LOG_LEVEL=INFO
    volumes:
      - ./services:/app/services
      - ./data:/app/data
      - ./protocol:/app/protocol
    command: >
      python -c "
      import asyncio
      import sys
      import os
      sys.path.insert(0, '/app/services')
      
      from api_server import app
      import uvicorn
      
      async def main():
          print('='*60)
          print('Entity B - API Server Starting')
          print('='*60)
          print(f'Entity ID: entity-b')
          print(f'Port: 8002')
          print(f'Target Entity A: http://entity-a:8001')
          print('='*60)
          
          # Start API server
          config = uvicorn.Config(app, host='0.0.0.0', port=8002, log_level='info')
          server = uvicorn.Server(config)
          await server.serve()
      
      asyncio.run(main())
      "
    networks:
      - ai-network
      - peer-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Entity B Token System テスト
  entity-b-token-test:
    build: .
    container_name: entity-b-token-test
    environment:
      - ENTITY_ID=entity-b
      - ENTITY_A_URL=http://entity-a:8001
      - PYTHONPATH=/app
    volumes:
      - ./services:/app/services
      - ./data:/app/data
    command: >
      python -c "
      import asyncio
      import sys
      import os
      import time
      sys.path.insert(0, '/app/services')
      
      print('='*60)
      print('Entity B - Token Transfer E2E Test')
      print('='*60)
      
      # Wait for Entity A
      print('Waiting for Entity A...')
      import urllib.request
      max_retries = 30
      for i in range(max_retries):
          try:
              urllib.request.urlopen('http://entity-a:8001/health', timeout=2)
              print(f'Entity A is ready!')
              break
          except:
              print(f'  Retry {i+1}/{max_retries}...')
              time.sleep(2)
      else:
          print('ERROR: Entity A not available')
          sys.exit(1)
      
      # Test 1: Create wallet on Entity B
      print('\n[Test 1] Creating wallet on Entity B...')
      req = urllib.request.Request(
          'http://localhost:8002/token/wallet/create',
          data=b'{}',
          headers={'Content-Type': 'application/json'},
          method='POST'
      )
      try:
          response = urllib.request.urlopen(req, timeout=5)
          wallet_data = response.read().decode()
          print(f'  Wallet created: {wallet_data[:100]}...')
      except Exception as e:
          print(f'  ERROR: {e}')
      
      # Test 2: Check balance
      print('\n[Test 2] Checking wallet balance...')
      try:
          response = urllib.request.urlopen('http://localhost:8002/token/wallet/entity-b', timeout=5)
          balance_data = response.read().decode()
          print(f'  Balance: {balance_data}')
      except Exception as e:
          print(f'  ERROR: {e}')
      
      # Test 3: Request tokens from Entity A (if endpoint available)
      print('\n[Test 3] Requesting test tokens from Entity A...')
      print('  (This requires Entity A to have minting endpoint)')
      
      print('\n' + '='*60)
      print('Token E2E Test Completed!')
      print('='*60)
      "
    networks:
      - ai-network
      - peer-network
    depends_on:
      - entity-b

networks:
  ai-network:
    driver: bridge
  peer-network:
    driver: bridge
    external: true  # Entity Aと共有
