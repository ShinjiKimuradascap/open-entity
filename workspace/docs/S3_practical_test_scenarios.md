# S3实用化测试シナリオ設計

## 概要

Stage 3 (S3) 实用化测试は、Peer Protocol v1.0 の実運用環境での動作を検証する包括的テストです。

## テスト目的

1. **実用性検証**: 実際のAI間協調シナリオでの動作確認
2. **信頼性評価**: 長時間運転・高負荷時の安定性
3. **セキュリティ検証**: 攻撃シナリオに対する耐性
4. **相互運用性**: 異なる環境間での通信確認

---

## テストシナリオ一覧

### S3-S1: Entity間タスク委譲フロー

**目的**: 基本的なタスク委譲が正常に動作すること

**手順**:
1. Entity Aがタスクを作成
2. Entity Bにタスク委譲メッセージを送信
3. Entity Bがタスクを受け入れ・実行
4. 結果をEntity Aに返信
5. Aが結果を確認

**検証項目**:
- [ ] タスク委譲メッセージの署名検証
- [ ] タスクキューの動作
- [ ] 結果返信の正確性
- [ ] 統計情報の記録

**成功基準**: 100回連続でエラーなく完了

---

### S3-S2: 大容量データ転送

**目的**: 分割メッセージ機能の実用性検証

**手順**:
1. 1MBのJSONデータを作成
2. チャンク分割して送信
3. 受信側で再構築
4. 元データとの一致確認

**検証項目**:
- [ ] チャンク分割の正確性
- [ ] ネットワーク遅延時の再構築
- [ ] 一部チャンク紛失時の復元
- [ ] チェックサム検証

**成功基準**: 100MBまでのデータをエラーなく転送

---

### S3-S3: ハートビート死活監視

**目的**: 長時間運転時のピア健全性監視

**手順**:
1. 2つのエンティティを起動
2. 互いをピアとして登録
3. 30分間ハートビートを継続
4. 途中で一方を停止
5. 異常検出と復帰確認

**検証項目**:
- [ ] 定期的なハートビート送信
- [ ] タイムアウト検出（設定: 3回連続失敗）
- [ ] ステータス変更の検知
- [ ] 復帰後の再開

**成功基準**: 異常を10秒以内に検出

---

### S3-S4: リプレイ攻撃耐性

**目的**: セキュリティ要件の実用レベル検証

**手順**:
1. 正当なメッセージをキャプチャ
2. 同一メッセージを再送信
3. ノンス重複検出の確認
4. タイムスタンプ改竄の検出

**検証項目**:
- [ ] 同一ノンスの拒否
- [ ] 60秒以上過去のタイムスタンプ拒否
- [ ] 未来タイムスタンプの拒否
- [ ] 攻撃試行のログ記録

**成功基準**: すべての攻撃を検出・拒否

---

### S3-S5: 能力交換 (Capability Exchange)

**目的**: 異なる機能セットを持つエンティティ間の協調

**手順**:
1. Entity A（フル機能）を起動
2. Entity B（制限機能）を起動
3. capability_queryを送信
4. サポートされている機能を確認
5. 互換性のあるタスクのみ委譲

**検証項目**:
- [ ] capability_query/responseの交換
- [ ] サポート機能リストの正確性
- [ ] バージョンネゴシエーション
- [ ] 拡張フィールドの無視

**成功基準**: 機能差異を正しく認識・対応

---

### S3-S6: 並行タスク処理

**目的**: 高負荷時のパフォーマンス検証

**手順**:
1. 10個のタスクを同時に送信
2. 各タスクを異なるピアに委譲
3. すべての結果を収集
4. 処理時間とスループットを計測

**検証項目**:
- [ ] 並行メッセージ送信の成功
- [ ] キューの溢れ防止
- [ ] メモリ使用量の監視
- [ ] 処理時間の安定性

**成功基準**: 同時10タスクを30秒以内に完了

---

### S3-S7: ネットワーク分離と復帰

**目的**: 不安定なネットワーク環境での耐性

**手順**:
1. エンティティ間通信を確立
2. ネットワークを10秒間遮断
3. メッセージ送信を試行
4. リトライ動作を確認
5. ネットワーク復帰
6. 送信再開と成功確認

**検証項目**:
- [ ] 接続エラー時のリトライ
- [ ] 指数バックオフの動作
- [ ] 復帰後の自動再開
- [ ] 未送信メッセージの保持

**成功基準**: 復帰後に自動的に通信再開

---

## テスト実行計画

### Phase 1: 単体テスト (1-2日)
- S3-S1, S3-S2, S3-S3 を個別実行
- 各シナリオを10回繰り返し

### Phase 2: 統合テスト (2-3日)
- 複数シナリオを連続実行
- 24時間継続運転テスト

### Phase 3: 負荷テスト (1日)
- S3-S6を100タスク規模で実行
- パフォーマンス指標を収集

### Phase 4: セキュリティテスト (1日)
- S3-S4を詳細に実施
- ペネトレーションテスト

---

## テスト環境要件

### ハードウェア
- CPU: 2コア以上
- RAM: 4GB以上
- ストレージ: 10GB空き

### ネットワーク
- 同一ホスト内通信（localhost）
- または専用テストネットワーク
- 帯域: 10Mbps以上

### ソフトウェア
- Python 3.10+
- aiohttp
- cryptography

---

## 期待される成果物

1. **テスト実行レポート**: 各シナリオの結果と証跡
2. **パフォーマンスメトリクス**: レイテンシ、スループット、エラー率
3. **セキュリティ評価**: 脆弱性スキャン結果
4. **改善提案**: 発見された問題と推奨対策

---

## 関連ドキュメント

- protocol/peer_protocol_v1.0.md
- protocol/IMPLEMENTATION_GUIDE.md
- services/test_peer_service.py

---

**作成日**: 2026-02-01  
**バージョン**: 1.0  
**ステータス**: 設計完了
