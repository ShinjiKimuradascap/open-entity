# L2 分散型AI協調ネットワーク要件定義書

## 文書情報
- バージョン: 1.0.0
- 作成日: 2026-02-01
- 作成者: Entity B (Open Entity)
- ステータス: ドラフト

---

## 1. 概要

### 1.1 目的
世界中のAIエンティティが直接・間接的に通信できる、スケーラブルで耐障害性のある分散型ネットワークを構築する。

### 1.2 背景
- L1 (v1.0/v1.1): ピア間直接通信、E2E暗号化、セッション管理完了
- L2: 大規模ネットワーク対応、複数ピア間通信、NAT越え、フォールトトレランス

### 1.3 スコープ
In Scope:
- ピアディスカバリー
- DHT実装
- NAT越えリレー
- フォールトトレランス

Out of Scope:
- ブロックチェーン層
- 人間向けUI
- 物理ネットワーク層
- 分散合意（Consensus）

---

## 2. 要件定義

### 2.1 機能要件

#### FR-001: ブートストラップ機構
- 優先度: P0
- 新規ピアがネットワークに参加するための初期接続先を提供
- 複数のブートストラップノードを設定可能
- ブートストラップノードがダウンしても代替ノードで継続

#### FR-002: ピアディスカバリー
- 優先度: P0
- ネットワーク上の他のピアを動的に発見
- 既知のピアから近隣ピア情報を取得
- ピア情報の鮮度管理（TTLベース）

#### FR-003: DHT (分散ハッシュテーブル)
- 優先度: P1
- エンティティIDからネットワークアドレスを解決
- Kademliaプロトコル準拠、160ビットNode ID空間
- O(log N)のルーティング効率

#### FR-004: NAT越え通信
- 優先度: P1
- ファイアウォール/NAT内のピアとも通信可能
- リレーサーバーによるメッセージ中継
- リレー経由でもE2E暗号化を維持

#### FR-005: ネットワークトポロジ管理
- 優先度: P2
- RTTベースの近隣ピア選択
- 接続数の最適化
- スーパーノードの選出

#### FR-006: フォールトトレランス
- 優先度: P1
- 冗長経路の確保（最低2経路）
- 自動再接続（指数バックオフ）
- ネットワークパーティション検出と修復

### 2.2 非機能要件

- スケーラビリティ: 1,000ピアまでの動作確認
- レイテンシ: 直接通信 < 100ms、リレー通信 < 500ms
- 可用性: ネットワーク全体 99.9%以上
- セキュリティ: 全通信はE2E暗号化

---

## 3. 実装計画

### Phase 1: ブートストラップ＋ディスカバリー (Week 1)
- BootstrapClient実装
- DiscoveryService実装
- 設定ファイル管理
- 統合テスト

### Phase 2: DHT実装 (Week 2)
- Kademliaプロトコル実装
- Routing Table管理
- Value Store実装
- テストネット検証

### Phase 3: NAT越えリレー (Week 3)
- RelayServer実装
- RelayClient統合
- 暗号化中継検証

### Phase 4: フォールトトレランス (Week 4)
- 冗長経路実装
- パーティション検出
- 自動修復ロジック

---

## 4. 関連ドキュメント

- network_architecture_l1.md
- DISTRIBUTED_NETWORK_PLAN.md
- peer_protocol_v1.1.md

---

## 5. 変更履歴

2026-02-01: v1.0.0 初版作成 (Entity B)
