# v1.1 Protocol Integration Test Plan

## 概要
v1.1プロトコルの統合テスト計画。新機能の統合検証と回帰テストを含む。

## テスト対象機能

### 1. E2E暗号化レイヤー (P0)
| テスト項目 | 検証内容 | 期待結果 |
|------------|----------|----------|
| X25519鍵交換 | ハンドシェイク成功 | 共有鍵が一致 |
| AES-256-GCM | ペイロード暗号化/復号 | 元データと一致 |
| セッション確立 | 3-wayハンドシェイク | ESTABLISHED状態 |
| PFS | エフェメラル鍵生成 | 毎回異なる鍵 |
| リプレイ保護 | シーケンス番号検証 | 古いメッセージ拒否 |

**テストファイル**: services/test_e2e_crypto.py

### 2. セッション管理 (P0 - CRITICAL)
| テスト項目 | 検証内容 | 期待結果 |
|------------|----------|----------|
| セッション作成 | UUID v4生成 | 有効なセッションID |
| 有効期限管理 | タイムアウト処理 | 期限切れセッション拒否 |
| シーケンス検証 | 順序保証 | 順不同メッセージ検出 |
| 同時セッション | 複数セッション管理 | 独立した暗号化状態 |
| セッション復帰 | 切断後再接続 | 新規ハンドシェイク成功 |

**テストファイル**: services/test_session_manager.py

### 3. レート制限 (P1)
| テスト項目 | 検証内容 | 期待結果 |
|------------|----------|----------|
| トークンバケット | リクエスト制限 | 制限超過時拒否 |
| ピア別制限 | 個別バケット | ピアAの超過がBに影響なし |
| バースト処理 | 短時間集中 | 許容範囲内は通過 |
| 制限リセット | 時間経過 | バケット回復 |
| DoS保護 | 異常リクエスト | 急速な拒否 |

**テストファイル**: services/test_rate_limiter.py

## 統合テストシナリオ

### シナリオ1: 完全な通信フロー
Entity A → Entity B
1. capability_query (署名検証)
2. handshake (X25519鍵交換)
3. handshake_ack (応答)
4. handshake_confirm (確立)
5. task_delegate (暗号化メッセージ)
6. status_report (暗号化応答)
7. セッション終了/期限切れ

### シナリオ2: エラーハンドリング
1. 無効な署名 → 拒否
2. リプレイ攻撃 → 検出
3. 期限切れセッション → 再ハンドシェイク要求
4. レート制限超過 → 429応答
5. ネットワーク分割 → 非同期復旧

## 回帰テスト

### 必須確認項目
- v1.0メッセージとの後方互換性
- Ed25519署名検証
- JWT認証
- チャンク転送
- 既存のピア通信

## 成功基準

| カテゴリ | カバレッジ目標 |
|----------|----------------|
| E2E暗号化 | 90%+ |
| セッション管理 | 85%+ |
| レート制限 | 80%+ |
| 統合シナリオ | 5+ シナリオ |

---
作成日: 2026-02-01
作成者: Entity B
