# v1.2 Phase 1: DHT Foundation 詳細設計

## 概要

Peer Communication Protocol v1.2のPhase 1として、DHT（分散ハッシュテーブル）基盤を構築する。
既存の複数DHT実装を統合し、シンプルで保守可能なアーキテクチャに再構成する。

## 現状分析

### 既存DHT実装（4ファイル）

| ファイル | 目的 | ステータス |
|---------|------|----------|
| `services/dht.py` | カスタムKademlia実装（低レベル） | 重複あり |
| `services/dht_registry.py` | kademliaライブラリ使用（シンプル） | ベース候補 |
| `services/kademlia_dht.py` | kademliaライブラリ使用（詳細） | 統合対象 |
| `services/distributed_registry.py` | Gossip + CRDT実装 | 別機能として維持 |

### 統合戦略

DHTRegistry（統合版）を中心に、kademliaライブラリを使用して分散ピア発見を実現。
既存の重複実装を整理し、単一の保守可能な実装に統合する。

## 設計詳細

### 1. 統合DHTRegistryクラス

ファイル: `services/dht_registry.py`（既存を拡張）

主要機能:
- Kademlia DHTによる分散ピア発見
- 署名付きPeerInfo
- ブートストラップノード管理
- 自動リフレッシュ
- PeerService統合

### 2. PeerInfoスキーマ

- peer_id: SHA256(public_key)
- entity_id, entity_name, endpoint
- public_key: Base64 Ed25519 public key
- capabilities, timestamp, ttl
- signature: 上記フィールドの署名

### 3. PeerService統合ポイント

- PeerService.__init__: DHTRegistry初期化
- PeerService.start(): DHTサーバー開始
- PeerService.discover_peers(): DHT検索使用

## 実装タスク

### Week 1: 統合実装

- [x] 既存コード分析完了
- [ ] DHTRegistry統合版実装
- [ ] PeerInfo署名検証実装
- [ ] ブートストラップ設定読み込み

### Week 2: PeerService統合

- [ ] PeerService統合
- [ ] ピア発見API実装
- [ ] 統合テスト

## テスト計画

単体テスト:
- test_peer_registration
- test_peer_lookup
- test_signature_verification
- test_bootstrap_connection

統合テスト:
- test_two_node_discovery
- test_bootstrap_node_discovery
- test_capability_filtering

## 次のステップ

1. DHTRegistry統合版の実装（S2）
2. PeerService統合（S3）
3. 統合テスト（S4）
4. Phase 2（Multi-hop routing）設計開始（M2）

---
作成日: 2026-02-01
ステータス: 設計完了・実装開始
