# v1.2 Phase 1: DHT Foundation Design

## 概要

Peer Protocol v1.2 Phase 1では、既存の複数DHT実装を統合し、堅牢なDHT Foundationレイヤーを構築する。

## 現状分析

### 既存DHT実装一覧

| ファイル | 主要クラス | 実装方式 | ステータス |
|---------|-----------|---------|-----------|
| services/dht.py | KademliaDHT, DHTPeerDiscovery, KBucket | 自前実装 | アクティブ |
| services/dht_node.py | DHTNode, DHTClient, NodeID | 自前実装 | アクティブ |
| services/kademlia_dht.py | DHTRegistry, PeerInfo | 外部ライブラリ | 重複 |
| services/distributed_registry.py | DistributedRegistry, VectorClock | CRDT統合 | アクティブ |

## 設計目標

### Phase 1.1: DHT実装統合
- 統一DHTインターフェース定義
- dht.py と dht_node.py の統合
- kademlia_dht.py の統合または廃止判断
- 重複コードの削除

### Phase 1.2: DHT Registry最適化
- DistributedRegistry のパフォーマンス改善
- Vector Clock最適化
- Gossipプロトコル帯域最適化

## 技術仕様

### Kademliaパラメータ

- K_BUCKET_SIZE: 20
- ALPHA: 3
- KEY_SIZE: 160 bits
- REFRESH_INTERVAL: 3600s
- EXPIRATION_TIME: 86400s

## 統合戦略

### ステップ1: コード重複分析
1. dht.py と dht_node.py の共通部分を抽出
2. KBucket 実装の統合
3. NodeInfo クラスの統一

### ステップ2: 統一DHTモジュール作成
- services/dht/__init__.py
- services/dht/router.py
- services/dht/kbucket.py
- services/dht/node.py
- services/dht/protocol.py

## 実装計画

| タスクID | 内容 | 見積時間 |
|---------|------|---------|
| DHT-001 | 既存コード詳細分析 | 2h |
| DHT-002 | 統一インターフェース設計 | 2h |
| DHT-003 | services/dht/ ディレクトリ作成 | 1h |
| DHT-004 | coreモジュール実装 | 4h |
| DHT-005 | 既存コード移行 | 4h |
| DHT-006 | 統合テスト作成 | 3h |

## 次のステップ

1. 既存コードの詳細なdiff分析
2. 統一インターフェースの具体設計
3. 実装開始

---
Created: 2026-02-01 Entity A
Status: Design Phase
