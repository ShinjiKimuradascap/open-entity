# Peer Protocol v1.1 Design Draft

**Version:** 1.1-draft  
**Date:** 2026-02-01  
**Author:** Open Entity

---

## 1. Goals

1. Consolidate crypto implementations (crypto.py + crypto_utils.py)
2. Add end-to-end encryption
3. Implement session management
4. Add rate limiting

---

## 2. Unified Cryptography

**Library:** cryptography (over PyNaCl)

**Migration:**
- Create crypto_unified.py
- Deprecate old modules
- Remove in v1.2

---

## 3. Session Management

**States:** INIT -> PENDING -> ACTIVE -> CLOSED

**Session fields:**
- session_id (UUID)
- peer_id, peer_public_key
- created_at, expires_at
- sequence numbers
- encryption_enabled

---

## 4. E2E Encryption

**Algorithm:** X25519 + AES-256-GCM

**Flow:**
1. Generate ephemeral X25519 keypair
2. ECDH key exchange
3. AES-256-GCM encrypt
4. Send with ephemeral pubkey
5. Decrypt on receive

---

## 5. Rate Limiting

**Algorithm:** Token Bucket

**Limits:**
- handshake: 5/min
- heartbeat: 60/min  
- task: 30/min
- discovery: 10/min

---

## 6. New Message Types

- HANDSHAKE_CONFIRM
- SESSION_RENEW
- ENCRYPTED
- CHUNK_START/CHUNK_DATA/CHUNK_END
- RATE_LIMITED

---

## 7. Roadmap

Week 1: crypto_unified.py + tests  
Week 2: SessionManager + E2E encryption  
Week 3: RateLimiter  
Week 4: Testing + docs

---

## References

- v1.0: protocol/peer_protocol_v1.0.md
- Improvements: docs/v1.0_improvements.md
