# Peer Protocol v1.2 Design Document

## Overview

v1.2ではスケーラビリティと信頼性の向上を目指し、以下の3つの主要機能を導入する：

1. Connection Pooling - HTTPコネクションの効率的な再利用
2. Circuit Breaker - 障害検知と自動復旧メカニズム
3. DHT-based Peer Discovery - 分散ハッシュテーブルによるピア発見

## 1. Connection Pooling

### 現状の課題
peer_service.py内でaiohttp.ClientSessionを7箇所で毎回新規作成。
これによりTCP接続のオーバーヘッドが発生し、高頻度通信時に性能劣化。

### 設計
ConnectionPoolManagerクラスを実装し、ピアごとのセッションを管理。
TCPConnectorでlimitとkeepaliveを設定。

### 性能目標
- 接続確立時間: 50ms to 5ms（10倍改善）
- DNSキャッシュ: 5分間保持

## 2. Circuit Breaker

### 設計
CircuitBreakerクラスでCLOSED/OPEN/HALF_OPENの3状態を管理。
失敗閾値でOPEN、時間経過でHALF_OPEN、成功でCLOSEDに遷移。

## 3. DHT-based Peer Discovery

### 設計
KademliaRouterを実装し、160個のKBucketでノードを管理。
XOR距離で近傍ノードを検索。

## Implementation Roadmap

- Phase 1: Connection Pooling (Week 1-2)
- Phase 2: Circuit Breaker (Week 3)
- Phase 3: DHT Foundation (Week 4-5)
- Phase 4: DHT Integration (Week 6-7)
- Phase 5: Testing (Week 8)

---
Last Updated: 2026-02-01
Status: Draft
