# 2つのAIエンティティをペアで起動する設定
# 使用方法: docker compose -f docker-compose.yml -f docker-compose.pair.yml --env-file ../.env up -d

services:
  # Entity A（メイン）
  entity-a:
    build: .
    container_name: entity-a
    ports:
      - "8001:8000"
    volumes:
      - ./profiles:/app/profiles:ro
      - moco_data_a:/app/data
      - ${MOCO_WORKSPACE:-./workspace}:/home/moco/workspace
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - MOONSHOT_API_KEY=${MOONSHOT_API_KEY}
      - MOCO_PROFILE=${MOCO_PROFILE:-entity}
      - LLM_PROVIDER=moonshot
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-moonshotai/kimi-k2.5}
      - MOCO_WORKING_DIRECTORY=/home/moco/workspace
      # ピア設定（コンテナ内は8000）
      - ENTITY_PORT=8000
      - PEER_PORT=8000
      - PEER_HOST=entity-b
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    # read_only removed to allow pytest and file writes
    tmpfs:
      - /tmp:size=200M,mode=1777
      - /var/tmp:size=100M,mode=1777
      - /home/moco/.moco:size=100M,mode=1777
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    networks:
      - entity-network

  # Entity B（ピア）
  entity-b:
    build: .
    container_name: entity-b
    ports:
      - "8002:8000"
    volumes:
      - ./profiles:/app/profiles:ro
      - moco_data_b:/app/data
      - ${MOCO_WORKSPACE:-./workspace}:/home/moco/workspace
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - MOONSHOT_API_KEY=${MOONSHOT_API_KEY}
      - MOCO_PROFILE=${MOCO_PROFILE:-entity}
      - LLM_PROVIDER=moonshot
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-moonshotai/kimi-k2.5}
      - MOCO_WORKING_DIRECTORY=/home/moco/workspace
      # ピア設定（コンテナ内は8000）
      - ENTITY_PORT=8000
      - PEER_PORT=8000
      - PEER_HOST=entity-a
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    # read_only removed to allow pytest and file writes
    tmpfs:
      - /tmp:size=200M,mode=1777
      - /var/tmp:size=100M,mode=1777
      - /home/moco/.moco:size=100M,mode=1777
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    networks:
      - entity-network

volumes:
  moco_data_a:
  moco_data_b:

networks:
  entity-network:
    driver: bridge
