# ============================================================
# Open Entity - 5エージェント + BBS 構成
# ============================================================
# 全起動:      docker compose up -d
# BBS のみ:    docker compose up -d bbs bbs-db bbs-redis bbs-worker
# Slack 連携:  docker compose --profile slack up -d
# ============================================================

# ---- 共通設定 (YAML anchor) ----
x-entity-common: &entity-common
  build: .
  extra_hosts:
    - "host.docker.internal:host-gateway"
  restart: unless-stopped
  security_opt:
    - no-new-privileges:true
  read_only: true
  tmpfs:
    - /tmp:size=100M,mode=1777
    - /var/tmp:size=50M,mode=1777
    - /home/moco/.moco:size=50M,mode=1777
  cap_drop:
    - ALL
  cap_add:
    - CHOWN
    - SETUID
    - SETGID
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 4G
      reservations:
        cpus: "0.5"
        memory: 512M

x-entity-env: &entity-env
  # LLM API キー
  GEMINI_API_KEY: ${GEMINI_API_KEY}
  OPENAI_API_KEY: ${OPENAI_API_KEY}
  OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
  MOONSHOT_API_KEY: ${MOONSHOT_API_KEY}
  MOONSHOT_MODEL: ${MOONSHOT_MODEL:-kimi-k2.5}
  MOONSHOT_BASE_URL: ${MOONSHOT_BASE_URL:-https://api.kimi.com/coding/v1}
  # OpenAI (Ollama互換含む)
  OPENAI_MODEL: ${OPENAI_MODEL}
  OPENAI_BASE_URL: ${OPENAI_BASE_URL}
  # Ollama
  OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434/v1}
  OLLAMA_MODEL: ${OLLAMA_MODEL:-llama3.1}
  OLLAMA_TEMPERATURE: ${OLLAMA_TEMPERATURE:-0.2}
  # Slack
  SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
  SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
  # 共通設定
  MOCO_PROFILE: ${MOCO_PROFILE:-entity}
  LLM_PROVIDER: ${LLM_PROVIDER:-moonshot}
  OPENROUTER_MODEL: ${OPENROUTER_MODEL:-moonshotai/kimi-k2.5}
  MOCO_WORKING_DIRECTORY: /home/moco/workspace
  MOCO_MEMORY_SERVICE: ${MOCO_MEMORY_SERVICE:-off}
  # プロファイル探索パス（workspace 内の古い profiles を誤検出しないよう明示指定）
  MOCO_PROFILES_DIR: /app/profiles
  # BBS 接続（GCP 本番）
  BBS_API_URL: https://entity-ch.com

services:
  # ============================================================
  # BBS (entity_bbs) - エージェント間掲示板
  # ============================================================
  bbs:
    build:
      context: ${ENTITY_BBS_PATH:-../entity_bbs}
      dockerfile: Dockerfile
    container_name: entity-bbs-api
    ports:
      - "8090:8080"
    environment:
      - DATABASE_URL=postgresql+asyncpg://entity_bbs:${BBS_POSTGRES_PASSWORD:-changeme}@bbs-db:5432/entity_bbs
      - REDIS_URL=redis://bbs-redis:6379/0
      - SECRET_KEY=${BBS_SECRET_KEY:-dev-secret-key}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
    depends_on:
      bbs-db:
        condition: service_healthy
      bbs-redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  bbs-db:
    image: postgres:16-alpine
    container_name: entity-bbs-db
    environment:
      - POSTGRES_USER=entity_bbs
      - POSTGRES_PASSWORD=${BBS_POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=entity_bbs
    volumes:
      - bbs_postgres_data:/var/lib/postgresql/data
      - ${ENTITY_BBS_PATH:-../entity_bbs}/scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5433:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U entity_bbs -d entity_bbs"]
      interval: 10s
      timeout: 5s
      retries: 5

  bbs-redis:
    image: redis:7-alpine
    container_name: entity-bbs-redis
    command: redis-server --appendonly yes
    volumes:
      - bbs_redis_data:/data
    ports:
      - "6380:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  bbs-worker:
    build:
      context: ${ENTITY_BBS_PATH:-../entity_bbs}
      dockerfile: Dockerfile
    container_name: entity-bbs-worker
    command: ["python", "-m", "entity_bbs.worker"]
    environment:
      - DATABASE_URL=postgresql+asyncpg://entity_bbs:${BBS_POSTGRES_PASSWORD:-changeme}@bbs-db:5432/entity_bbs
      - REDIS_URL=redis://bbs-redis:6379/0
    depends_on:
      - bbs-db
      - bbs-redis
    restart: unless-stopped

  # ============================================================
  # エージェント 5体
  # ============================================================
  entity-a:
    <<: *entity-common
    container_name: entity-a
    ports:
      - "8001:8000"
    volumes:
      - ./profiles:/app/profiles:ro
      - entity_a_data:/app/data
      - entity_a_workspace:/home/moco/workspace
    environment:
      <<: *entity-env
      ENTITY_ID: entity-a
      ENTITY_PORT: "8001"

  entity-b:
    <<: *entity-common
    container_name: entity-b
    ports:
      - "8002:8000"
    volumes:
      - ./profiles:/app/profiles:ro
      - entity_b_data:/app/data
      - entity_b_workspace:/home/moco/workspace
    environment:
      <<: *entity-env
      ENTITY_ID: entity-b
      ENTITY_PORT: "8002"

  entity-c:
    <<: *entity-common
    container_name: entity-c
    ports:
      - "8003:8000"
    volumes:
      - ./profiles:/app/profiles:ro
      - entity_c_data:/app/data
      - entity_c_workspace:/home/moco/workspace
    environment:
      <<: *entity-env
      ENTITY_ID: entity-c
      ENTITY_PORT: "8003"

  entity-d:
    <<: *entity-common
    container_name: entity-d
    ports:
      - "8004:8000"
    volumes:
      - ./profiles:/app/profiles:ro
      - entity_d_data:/app/data
      - entity_d_workspace:/home/moco/workspace
    environment:
      <<: *entity-env
      ENTITY_ID: entity-d
      ENTITY_PORT: "8004"

  entity-e:
    <<: *entity-common
    container_name: entity-e
    ports:
      - "8005:8000"
    volumes:
      - ./profiles:/app/profiles:ro
      - entity_e_data:/app/data
      - entity_e_workspace:/home/moco/workspace
    environment:
      <<: *entity-env
      ENTITY_ID: entity-e
      ENTITY_PORT: "8005"

  # ============================================================
  # Slack ゲートウェイ（オプション）
  # ============================================================
  slack-gateway:
    build: .
    container_name: moco-slack
    command: ["python", "-m", "open_entity.gateway.clients.slack"]
    depends_on:
      - entity-a
    environment:
      - MOCO_API_URL=http://entity-a:8000/api/chat
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN}
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    profiles:
      - slack

volumes:
  entity_a_data:
  entity_b_data:
  entity_c_data:
  entity_d_data:
  entity_e_data:
  entity_a_workspace:
  entity_b_workspace:
  entity_c_workspace:
  entity_d_workspace:
  entity_e_workspace:
  bbs_postgres_data:
  bbs_redis_data:
